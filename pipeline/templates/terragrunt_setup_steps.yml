parameters:
  - name: subscription
    type: string

steps:
  - bash: |
      echo "Checking if Terragrunt is installed..."
      if command -v terragrunt; then
        echo "Terragrunt already installed."
      else
        echo "Terragrunt not found. Installing..."
        wget https://github.com/gruntwork-io/terragrunt/releases/latest/download/terragrunt_linux_amd64
        mv terragrunt_linux_amd64 terragrunt
        chmod +x terragrunt
        sudo mv terragrunt /usr/local/bin
        terragrunt -v
      fi
    displayName: 'Install Terragrunt'

  - bash: |
      echo "Checking if Terraform is installed..."
      if command -v terraform; then
        echo "Terraform already installed."
      else
        echo "Terraform not found. Downloading..."
        wget https://releases.hashicorp.com/terraform/1.11.4/terraform_1.11.4_linux_amd64.zip

        echo "Checking for Zip..."
          if command -v zip; then
            echo "Zip already installed."
          else
            "Zip not found. Installing Zip..."
            sudo apt-get install zip -y
          fi

        "Installing Terraform..."
        unzip terraform_1.11.4_linux_amd64.zip
        sudo mv ./terraform /usr/local/bin/
        terraform -v

        # cleanup unnecessary files
        rm -f license.txt terraform_1.11.4_linux_amd64.zip
      fi
    displayName: 'Install Terraform v1.11.4'

  - bash: |
      echo "checking if Azure CLI is installed..."
      if command -v az; then
        echo "Azure CLI already installed."
      else
        echo "Azure CLI not found. Installing..."
        bash '$(System.DefaultWorkingDirectory)/pipeline/scripts/install_cli.sh'
      fi
    displayName: 'Install Azure CLI'

  - task: AzureCLI@2
    displayName: 'Authenticate Terraform'
    inputs:
      scriptType: bash
      scriptLocation: inlineScript
      azureSubscription: ${{parameters.subscription}}
      addSpnToEnvironment: true
      inlineScript: |
        echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(az account show --query id --output tsv)"
        echo "##vso[task.setvariable variable=ARM_TENANT_ID]$tenantId"
        echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$servicePrincipalId"
        echo "##vso[task.setvariable variable=ARM_OIDC_TOKEN]$idToken"
        echo "##vso[task.setvariable variable=ARM_USE_OIDC]true"
